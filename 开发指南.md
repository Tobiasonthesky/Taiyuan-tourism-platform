# 开发指南

本文档包含项目开发相关的技术说明，包括地图功能集成、数据库设计、路径配置等。

## 目录
- [地图功能集成](#地图功能集成)
- [数据库设计说明](#数据库设计说明)
- [路径配置说明](#路径配置说明)
- [酒店最低价格计算](#酒店最低价格计算)

---

## 地图功能集成

### 概述

地图功能已成功集成到太原文旅平台的各个业务模块中，实现了位置展示、导航、详情跳转等功能。

### 已实现的集成功能

#### 1. 详情页 → 地图页跳转

在景点和酒店详情页添加了"查看地图"按钮，点击后可以：
- 跳转到地图页面
- 自动定位到该地点
- 显示该地点的标记和信息窗口

**支持的页面：**
- ✅ **景点详情页** (`/attraction/:id`)
- ✅ **酒店详情页** (`/hotel/:id`)
- ✅ **文化详情页** (`/culture/:id`) - 支持活动地点定位

**使用方法：**
在详情页点击"查看地图"按钮即可。

#### 2. 地图页 → 详情页跳转

在地图的信息窗口中添加了"查看详情"按钮，点击后可以：
- 跳转到对应的详情页（景点/酒店）
- 查看完整的信息、图片、评论等

**支持的标记类型：**
- ✅ **景点标记**：跳转到景点详情页
- ✅ **酒店标记**：跳转到酒店详情页
- ✅ **餐厅标记**：餐厅数据来自美食的推荐餐厅JSON字段
- ✅ **文化标记**：跳转到文化详情页（活动地点）

#### 3. URL参数定位

地图页面支持通过URL参数直接定位到指定地点：

```
/map?type=attraction&id=1&lng=112.549248&lat=37.857014&name=晋祠
```

**参数说明：**
- `type`: 类型（attraction/hotel/restaurant/culture）
- `id`: 数据ID
- `lng`: 经度
- `lat`: 纬度
- `name`: 地点名称（可选）

**使用场景：**
- 从详情页跳转过来时自动定位
- 分享链接时直接定位到指定地点
- 攻略中的路线规划链接

### 功能流程

#### 场景1：从详情页查看地图

1. 用户在景点/酒店详情页浏览信息
2. 点击"查看地图"按钮
3. 跳转到地图页面，URL包含定位参数
4. 地图自动定位到该地点，显示标记和信息窗口
5. 用户可以：
   - 查看周边其他景点/酒店
   - 规划导航路线
   - 点击其他标记查看详情

#### 场景2：从地图查看详情

1. 用户在地图页面浏览标记
2. 点击某个标记，打开信息窗口
3. 点击信息窗口中的"查看详情"按钮
4. 跳转到对应的详情页
5. 用户可以：
   - 查看完整信息
   - 查看图片/视频
   - 查看评论
   - 进行预订/收藏操作

### 代码实现位置

#### 前端文件

1. **详情页集成**：
   - `src/views/attraction/Detail.vue` - 景点详情页
   - `src/views/hotel/Detail.vue` - 酒店详情页

2. **地图页面**：
   - `src/views/map/Index.vue` - 地图主页面
   - 包含URL参数处理、信息窗口详情按钮、跳转逻辑

#### 关键方法

**详情页 → 地图页：**
```javascript
viewOnMap() {
  this.$router.push({
    path: '/map',
    query: {
      type: 'attraction',  // 或 'hotel'
      id: this.attraction.id,
      lng: this.attraction.longitude,
      lat: this.attraction.latitude,
      name: this.attraction.name
    }
  })
}
```

**地图页 → 详情页：**
```javascript
goToDetail(type, id) {
  let path = ''
  switch (type) {
    case 'attraction':
      path = `/attraction/${id}`
      break
    case 'hotel':
      path = `/hotel/${id}`
      break
  }
  this.$router.push(path)
}
```

### 注意事项

1. **坐标数据完整性**：
   - 确保景点和酒店数据中包含 `longitude` 和 `latitude` 字段
   - 如果缺少坐标，地图功能将无法使用

2. **数据同步**：
   - 地图数据来自后端API (`/api/map/all`)
   - 确保后端数据与前端显示一致

3. **URL参数验证**：
   - 地图页面会验证URL参数的有效性
   - 无效参数会被忽略，不会导致错误

4. **浏览器兼容性**：
   - 地图功能依赖高德地图JS API
   - 需要现代浏览器支持

### 后续扩展建议

1. **攻略路线规划** - 在攻略详情页添加路线规划功能
2. **附近推荐** - 在首页或列表页添加基于位置的推荐
3. **收藏地图** - 在收藏页面添加地图视图
4. **订单地图** - 在订单详情页显示酒店/体验项目的位置
5. **美食推荐餐厅地图** - 完善美食详情页，在地图上显示所有推荐餐厅

---

## 数据库设计说明

### 当前数据库状态

#### ✅ 无需修改的表

1. **景点表（attraction）**
   - 已有 `longitude`（经度）字段
   - 已有 `latitude`（纬度）字段
   - ✅ 可以直接使用

2. **酒店表（hotel）**
   - 已有 `longitude`（经度）字段
   - 已有 `latitude`（纬度）字段
   - ✅ 可以直接使用

#### ⚠️ 需要确认的表

3. **美食表（food）**
   - 有 `recommendedRestaurants` JSON字段
   - 当前实现从该字段提取餐厅信息
   - 需要确认JSON格式是否包含经纬度

4. **文化表（culture）**
   - 有 `activityLocation`（活动地点）字段
   - 有 `longitude`（经度）字段
   - 有 `latitude`（纬度）字段
   - ✅ 可以直接使用

5. **体验项目表（experience）**
   - 有 `longitude`（经度）字段
   - 有 `latitude`（纬度）字段
   - ✅ 可以直接使用

### 餐厅数据处理方案

#### 方案一：使用现有JSON字段（推荐，无需修改数据库）

**优点：**
- 无需修改数据库结构
- 实现简单，已集成到代码中
- 适合餐厅数据较少的情况

**要求：**
确保 `food.recommendedRestaurants` 字段的JSON格式包含经纬度：

```json
[
  {
    "name": "餐厅名称",
    "longitude": 112.549248,
    "latitude": 37.857014,
    "address": "餐厅地址",
    "image": "餐厅图片URL"
  }
]
```

**如果现有数据没有经纬度，需要：**
1. 通过高德地图API搜索餐厅地址获取经纬度
2. 更新数据库中的JSON数据

#### 方案二：创建独立餐厅表（可选，更规范）

**优点：**
- 数据结构更规范
- 便于餐厅数据管理
- 支持餐厅的独立CRUD操作
- 更好的查询性能

**缺点：**
- 需要修改数据库结构
- 需要修改后端代码（MapService）
- 需要数据迁移

### 数据准备检查清单

#### 景点数据
- [ ] 确认 `attraction` 表中的数据包含 `longitude` 和 `latitude`
- [ ] 如果缺少，使用高德地图API或手动补充

#### 酒店数据
- [ ] 确认 `hotel` 表中的数据包含 `longitude` 和 `latitude`
- [ ] 如果缺少，使用高德地图API或手动补充

#### 餐厅数据
- [ ] 检查 `food.recommendedRestaurants` JSON格式
- [ ] 确认JSON中包含 `longitude` 和 `latitude` 字段
- [ ] 如果缺少，选择方案一（补充JSON）或方案二（创建新表）

#### 文化数据
- [ ] 确认 `culture` 表中的数据包含 `activityLocation`、`longitude` 和 `latitude`
- [ ] 如果缺少，使用高德地图API或手动补充

#### 体验项目数据
- [ ] 确认 `experience` 表中的数据包含 `longitude` 和 `latitude`
- [ ] 如果缺少，使用高德地图API或手动补充

### 获取经纬度的方法

#### 方法1：使用高德地图API（推荐）

```java
// 在MapServiceImpl中添加方法
public Map<String, BigDecimal> geocodeAddress(String address) {
    // 调用高德地图地理编码API
    // https://restapi.amap.com/v3/geocode/geo?key=YOUR_KEY&address=地址
}
```

#### 方法2：手动查询

1. 访问高德地图开放平台：https://lbs.amap.com/tools/picker
2. 在地图上找到位置
3. 复制经纬度坐标

#### 方法3：使用高德地图搜索API

```java
// 使用searchPlace方法搜索餐厅名称
List<Map<String, Object>> places = mapService.searchPlace("餐厅名称", "太原");
// 从结果中提取经纬度
```

### 数据验证SQL

执行以下SQL检查数据完整性：

```sql
-- 检查景点数据
SELECT COUNT(*) as total, 
       COUNT(longitude) as has_lng, 
       COUNT(latitude) as has_lat
FROM attraction 
WHERE status = 1;

-- 检查酒店数据
SELECT COUNT(*) as total, 
       COUNT(longitude) as has_lng, 
       COUNT(latitude) as has_lat
FROM hotel 
WHERE status = 1;

-- 检查美食推荐餐厅数据（需要检查JSON格式）
SELECT id, name, recommended_restaurants
FROM food 
WHERE status = 1 
  AND recommended_restaurants IS NOT NULL 
  AND recommended_restaurants != ''
LIMIT 10;

-- 检查文化数据完整性
SELECT COUNT(*) as total, 
       COUNT(activity_location) as has_location,
       COUNT(longitude) as has_lng, 
       COUNT(latitude) as has_lat
FROM culture 
WHERE status = 1;

-- 检查体验项目数据完整性
SELECT COUNT(*) as total, 
       COUNT(longitude) as has_lng, 
       COUNT(latitude) as has_lat
FROM experience 
WHERE status = 1;
```

### 总结

**最小化修改方案（推荐）：**
- ✅ 景点表：已有经纬度字段，无需修改
- ✅ 酒店表：已有经纬度字段，无需修改
- ✅ 文化表：已有活动地点和经纬度字段，无需修改
- ✅ 体验项目表：已有经纬度字段，无需修改
- ✅ 餐厅数据：使用现有JSON字段，只需确保数据包含经纬度

**如果现有数据完整：无需修改数据库！**

只需确保：
1. 景点数据有经纬度
2. 酒店数据有经纬度
3. 文化数据有活动地点和经纬度
4. 体验项目数据有经纬度
5. 美食的 `recommendedRestaurants` JSON字段包含经纬度

如果数据不完整，需要补充数据，而不是修改数据库结构。

---

## 路径配置说明

### 修改内容

#### 1. 配置文件修改 (`application.yml`)

**修改前：**
```yaml
file:
  upload:
    path: D:/tourism-platform/uploads/
    max-size: 10485760
```

**修改后：**
```yaml
file:
  upload:
    path: ./uploads/  # 相对路径，相对于项目根目录
    max-size: 10485760
```

#### 2. FileUtil.java 修改

**主要改进：**
1. **添加了路径解析逻辑**：在 `@PostConstruct` 方法中初始化时解析相对路径
2. **自动创建目录**：如果上传目录不存在，自动创建
3. **跨平台兼容**：使用 `File.separator` 确保Windows和Linux都能正常工作
4. **路径规范化**：使用 `Paths.normalize()` 处理路径中的 `.` 和 `..`

**关键代码：**
```java
@PostConstruct
public void init() {
    // 如果路径是相对路径，转换为绝对路径
    Path path = Paths.get(uploadPath);
    if (!path.isAbsolute()) {
        // 获取项目根目录（jar包所在目录或工作目录）
        String baseDir = System.getProperty("user.dir");
        resolvedUploadPath = Paths.get(baseDir, uploadPath).normalize().toString();
    } else {
        resolvedUploadPath = uploadPath;
    }
    // ... 创建目录等逻辑
}
```

#### 3. WebMvcConfig.java 修改

**修改后：**
```java
@Value("${file.upload.path:./uploads/}")
private String uploadPath;

@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    String filePath = uploadPath.replace("\\", "/");
    if (!filePath.endsWith("/")) {
        filePath += "/";
    }
    registry.addResourceHandler("/uploads/**")
        .addResourceLocations("file:" + filePath);
}
```

### 路径解析规则

#### 相对路径解析
- **开发环境**：相对于项目根目录（`user.dir`）
- **生产环境（jar包）**：相对于jar包所在目录
- **Docker部署**：相对于容器工作目录

#### 路径示例

| 配置值 | 解析结果（假设项目在 `/app`） |
|--------|------------------------------|
| `./uploads/` | `/app/uploads/` |
| `uploads/` | `/app/uploads/` |
| `../uploads/` | `/uploads/`（项目父目录） |
| `/uploads/` | `/uploads/`（绝对路径，保持不变） |

### 迁移步骤

#### 1. 备份现有文件
如果已有上传的文件，请先备份：
```bash
# Windows
xcopy D:\tourism-platform\uploads .\uploads\ /E /I

# Linux/Mac
cp -r /path/to/uploads ./uploads
```

#### 2. 更新配置
修改 `application.yml` 中的路径配置为相对路径

#### 3. 重启应用
重启应用后，系统会自动：
- 解析相对路径为绝对路径
- 创建上传目录（如果不存在）
- 配置静态资源映射

#### 4. 验证
- 上传一个测试文件
- 检查文件是否保存在正确位置
- 访问上传的文件URL，确认可以正常访问

### 优势

#### 1. 可移植性
- ✅ 无需修改配置即可在不同环境部署
- ✅ 支持Windows、Linux、Mac等不同操作系统
- ✅ 支持Docker容器化部署

#### 2. 灵活性
- ✅ 可以轻松切换不同的存储位置
- ✅ 支持相对路径和绝对路径（向后兼容）
- ✅ 自动创建目录，减少手动配置

#### 3. 维护性
- ✅ 配置更简洁
- ✅ 减少环境差异导致的问题
- ✅ 便于版本控制和团队协作

### 注意事项

#### 1. 权限问题
确保应用有权限在项目目录下创建和写入文件：
```bash
# Linux/Mac
chmod -R 755 ./uploads

# 或者使用应用运行用户
chown -R appuser:appgroup ./uploads
```

#### 2. 磁盘空间
确保项目所在磁盘有足够的空间存储上传的文件

#### 3. 备份策略
建议定期备份 `uploads` 目录，避免数据丢失

#### 4. 生产环境建议
对于生产环境，建议：
- 使用绝对路径指向专门的存储目录（如 `/data/uploads/`）
- 或者使用对象存储服务（OSS、S3等）
- 配置定期备份

### 环境变量支持（可选）

如果需要通过环境变量配置路径，可以修改 `application.yml`：

```yaml
file:
  upload:
    path: ${UPLOAD_PATH:./uploads/}  # 优先使用环境变量，否则使用默认值
    max-size: 10485760
```

然后通过环境变量设置：
```bash
# Linux/Mac
export UPLOAD_PATH=/data/tourism/uploads/

# Windows
set UPLOAD_PATH=D:\data\tourism\uploads\
```

### 常见问题

#### Q1: 上传的文件找不到？
**A**: 检查：
1. 应用是否有写入权限
2. 路径是否正确解析（查看日志）
3. 静态资源映射是否正确

#### Q2: 在不同环境下路径解析不一致？
**A**: 确保使用相对路径 `./uploads/`，系统会自动基于 `user.dir` 解析

#### Q3: 如何查看实际使用的路径？
**A**: 在 `FileUtil.init()` 方法中添加日志：
```java
logger.info("文件上传路径: {}", resolvedUploadPath);
```

#### Q4: Docker部署时路径如何配置？
**A**: 
1. 使用相对路径 `./uploads/`（相对于容器工作目录）
2. 或者使用Volume挂载：`-v /host/uploads:/app/uploads`

---

## 酒店最低价格计算

### 功能说明

酒店的最低价格应该以房型的最低价格为准。系统已实现自动计算和更新机制，确保酒店列表和详情页显示的 `minPrice` 字段始终反映该酒店所有房型中的最低价格。

### 实现机制

#### 1. 服务层实现

在 `HotelServiceImpl` 中实现了以下方法：

**`updateHotelMinPrice(Long hotelId)`** - 更新指定酒店的最低价格
- 查询该酒店所有房型的最低价格
- 如果价格与当前 `minPrice` 不同，则更新

**`updateHotelMinPriceIfNeeded(Long hotelId, Hotel hotel)`** - 私有辅助方法
- 在获取酒店信息时自动检查并更新价格
- 确保返回的数据始终是最新的

#### 2. 自动更新触发点

系统在以下场景会自动更新酒店最低价格：

1. **获取酒店列表** - `getHotelList()` 方法
2. **获取酒店详情** - `getHotelDetail()` 方法
3. **搜索酒店** - `searchHotels()` 方法

#### 3. 房型操作触发更新

在 `AdminController` 中，以下操作会自动触发价格更新：

1. **创建房型** - `createHotelRoom()` 方法
2. **更新房型** - `updateHotelRoom()` 方法
3. **删除房型** - `deleteHotelRoom()` 方法

### 数据迁移

对于现有数据，可以使用提供的SQL脚本批量更新：

**文件：** `update_hotel_min_price.sql`

**执行步骤：**
1. 备份数据库
2. 执行SQL脚本更新所有酒店的最低价格
3. 验证更新结果

### 注意事项

1. **数据一致性**：系统确保 `minPrice` 字段始终反映房型的最低价格
2. **性能考虑**：更新操作在查询时进行，对性能影响较小
3. **空值处理**：如果酒店没有房型，`minPrice` 将设置为 `NULL`

### 验证方法

执行以下SQL验证价格是否正确：

```sql
-- 检查酒店最低价格
SELECT h.id, h.name, h.min_price, MIN(hr.price) as actual_min_price
FROM hotel h
LEFT JOIN hotel_room hr ON h.id = hr.hotel_id
GROUP BY h.id, h.name, h.min_price
HAVING h.min_price != MIN(hr.price) OR (h.min_price IS NULL AND MIN(hr.price) IS NOT NULL);
```

如果查询结果为空，说明所有酒店的价格都是正确的。

---

## 总结

本文档涵盖了项目开发中的关键技术点：

1. **地图功能集成** - 实现了详情页与地图页的双向跳转，URL参数定位等功能
2. **数据库设计** - 说明了数据库结构，数据准备要求，以及获取经纬度的方法
3. **路径配置** - 说明了从绝对路径迁移到相对路径的实现和优势
4. **酒店价格计算** - 说明了酒店最低价格的自动计算和更新机制

如有其他开发相关问题，请参考代码注释或联系开发团队。
