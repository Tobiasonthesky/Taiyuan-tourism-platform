# 配置指南

本文档包含项目的所有配置说明，包括AI功能、地图API、API密钥等配置。

## 目录
- [AI功能配置](#ai功能配置)
- [高德地图API配置](#高德地图api配置)
- [API密钥类型说明](#api密钥类型说明)
- [常见错误解决方案](#常见错误解决方案)

---

## AI功能配置

### 1. AI智能攻略生成助手

#### 功能概述
基于DeepSeek API实现的智能攻略生成功能。用户只需输入简单的需求信息（天数、预算、主题等），AI就会自动生成一份详细的旅游攻略。

#### 配置步骤

**1. 获取DeepSeek API密钥**
1. 访问 [DeepSeek开放平台](https://platform.deepseek.com/)
2. 注册/登录账号
3. 进入控制台，创建API密钥
4. 复制API密钥（格式类似：`sk-xxxxxxxxxxxxx`）

**2. 配置后端**
编辑 `tourism-platform-backend/src/main/resources/application.yml` 文件：

```yaml
# AI配置（DeepSeek）
ai:
  deepseek:
    enabled: true  # 设置为true启用AI功能
    api-key: your-deepseek-api-key-here  # 替换为你的DeepSeek API密钥
    base-url: https://api.deepseek.com  # DeepSeek API基础URL（一般不需要修改）
```

**重要提示：**
- 将 `enabled` 设置为 `true` 以启用AI功能
- 将 `api-key` 替换为你从DeepSeek平台获取的实际API密钥
- 确保API密钥保密，不要提交到代码仓库

**3. 重启后端服务**
配置完成后，重启Spring Boot后端服务使配置生效。

#### 使用方法

**用户端使用：**
1. 访问攻略页面（`/strategy`）
2. 点击"AI生成攻略"按钮
3. 填写游玩天数（必填）、预算、主题、兴趣偏好等信息
4. 点击"生成攻略"按钮
5. 等待AI生成（通常需要10-30秒）

**API接口：**
- **接口地址**：`POST /api/strategies/generate`
- **请求体示例**：
```json
{
  "duration": 2,
  "budget": 1000,
  "theme": "亲子",
  "interests": "历史,美食",
  "bestSeason": "春季",
  "requirements": "需要无障碍设施"
}
```

#### 注意事项
- **API费用**：DeepSeek API按调用次数收费，请注意控制使用频率
- **生成时间**：AI生成通常需要10-30秒，请耐心等待
- **内容审核**：生成的攻略保存后需要管理员审核才能发布
- **网络要求**：需要能够访问DeepSeek API（可能需要代理）

---

### 2. AI智能助手

#### 功能概述
AI智能助手是一个浮窗式对话助手，可以帮助用户查询网站内的景点、美食、酒店等信息，规划旅游路线，并与AI攻略生成功能对接。

#### 功能特点
- **浮窗式设计**：固定在页面右下角，随时可以点击展开/收起
- **智能对话**：基于DeepSeek AI，可以理解用户问题并给出专业回答
- **网站数据查询**：可以查询平台内的景点、美食、酒店、攻略等信息
- **攻略生成对接**：可以直接在对话窗口中打开AI攻略生成功能
- **对话历史**：支持多轮对话，保持上下文理解

#### 配置要求

确保 `application.yml` 中已配置DeepSeek API（与AI攻略生成共用配置）：

```yaml
ai:
  deepseek:
    enabled: true
    api-key: your-deepseek-api-key
    base-url: https://api.deepseek.com
```

#### 使用方法
- 在网站任意页面右下角可以看到AI助手浮窗按钮
- 点击按钮即可展开对话窗口
- 直接输入问题，点击"发送"按钮或按`Ctrl+Enter`发送
- 可以使用预设的快捷问题：推荐热门景点、美食推荐、规划路线、生成攻略

#### 可以询问的问题示例
- **景点相关**："推荐一些热门景点"、"有什么适合拍照的景点吗？"
- **美食相关**："有什么好吃的推荐吗？"、"推荐一些特色美食"
- **酒店相关**："推荐一些性价比高的酒店"、"有什么适合情侣的酒店吗？"
- **路线规划**："帮我规划一个2日游路线"、"我想去XX景点，怎么安排路线？"

---

## 高德地图API配置

### 一、获取高德地图API密钥

#### 1. 注册高德开放平台账号
访问 [高德开放平台](https://lbs.amap.com/)，注册并登录账号。

#### 2. 创建应用
1. 登录后进入「控制台」
2. 点击「应用管理」→「我的应用」
3. 点击「创建新应用」
4. 填写应用名称（如：太原文旅平台），选择应用类型（Web端）

#### 3. 添加Key
需要创建**两个Key**，分别用于前端和后端：

**前端Key（Web端JS API）：**
1. 在创建的应用下点击「添加」
2. 填写Key名称（如：Web端Key）
3. **服务平台选择「Web端(JS API)」** ⚠️ 非常重要
4. 设置白名单（开发环境可设置为 `*`，生产环境建议设置具体域名）
5. 点击「提交」获取Key

**后端Key（Web服务API）：**
1. 在同一个应用下再次点击「添加」
2. 填写Key名称（如：后端服务Key）
3. **服务平台选择「Web服务API」** ⚠️ 非常重要
4. 设置白名单（开发环境可设置为 `*`，生产环境建议设置服务器IP）
5. 点击「提交」获取Key

#### 4. 开通服务
确保以下服务已开通（默认已开通）：
- Web服务API（用于后端路线规划、地点搜索）
- Web端(JS API)（用于前端地图展示）

### 二、前端配置

#### 1. 创建环境变量文件

在 `tourism-platform-frontend` 目录下创建 `.env.development` 文件（开发环境）：

```env
VUE_APP_BASE_API=http://localhost:8080/api
VUE_APP_TITLE=太原文旅平台
VUE_APP_MAP_KEY=你的高德地图API密钥（Web端JS API类型）
```

在 `tourism-platform-frontend` 目录下创建 `.env.production` 文件（生产环境）：

```env
VUE_APP_BASE_API=http://your-domain.com/api
VUE_APP_TITLE=太原文旅平台
VUE_APP_MAP_KEY=你的高德地图API密钥（Web端JS API类型）
```

#### 2. 配置说明
- `VUE_APP_MAP_KEY`：填写你在高德开放平台获取的**Web端(JS API)**类型的Key
- 注意：开发环境和生产环境可以使用不同的Key，建议分别配置

### 三、后端配置

#### 1. 修改配置文件

编辑 `tourism-platform-backend/src/main/resources/application.yml`：

```yaml
# 地图API配置
map:
  api:
    key: 你的高德地图API密钥  # 填写Web服务API的Key（与前端Key不同）
    type: amap # amap-高德, baidu-百度
```

#### 2. 配置说明
- `map.api.key`：填写你在高德开放平台获取的**Web服务API**类型的Key
- `map.api.type`：地图类型，保持为 `amap`（高德地图）

### 四、功能说明

#### 已实现的功能
1. **地图展示** - 显示景点、餐厅、酒店位置，不同类型使用不同颜色的标记
2. **分类筛选** - 景点筛选、餐厅筛选、酒店筛选，支持多选
3. **地点搜索** - 搜索地点名称，显示搜索结果，自动定位到搜索结果
4. **路线规划** - 驾车导航、步行导航、公交导航，显示路线和距离
5. **当前位置定位** - 获取用户当前位置（需要HTTPS环境或localhost）
6. **信息窗口** - 点击标记显示详细信息，显示名称、地址、图片，快速导航按钮

---

## API密钥类型说明

### 重要说明

高德地图API需要**两个不同的Key**，分别用于前端和后端：

### 1. 前端（Web端JS API）

**Key类型：** `Web端(JS API)`

**用途：**
- 前端地图展示
- 地图标记、信息窗口
- 路线规划插件（Driving、Walking等）
- 定位功能

**配置位置：**
- 文件：`tourism-platform-frontend/.env.development`
- 变量：`VUE_APP_MAP_KEY`

**获取方式：**
1. 登录高德开放平台控制台
2. 创建应用 → 添加Key
3. **服务平台选择「Web端(JS API)」**
4. 白名单设置为 `localhost` 或 `*`（开发环境）

### 2. 后端（Web服务API）

**Key类型：** `Web服务API`

**用途：**
- 后端调用高德地图REST API
- 地点搜索（`/place/text`）
- 路线规划（`/direction/driving`等）
- 地理编码（`/geocode/geo`）

**配置位置：**
- 文件：`tourism-platform-backend/src/main/resources/application.yml`
- 配置项：`map.api.key`

**获取方式：**
1. 登录高德开放平台控制台
2. 创建应用 → 添加Key
3. **服务平台选择「Web服务API」**
4. 白名单设置为服务器IP或 `*`（开发环境）

### 前后端Key对照表

| 位置 | Key类型 | 用途 | 配置文件 |
|------|---------|------|---------|
| **前端** | **Web端(JS API)** | JavaScript SDK | `.env.development` → `VUE_APP_MAP_KEY` |
| **后端** | **Web服务API** | REST API调用 | `application.yml` → `map.api.key` |

⚠️ **重要**：前端和后端需要使用**不同类型的Key**！

---

## 常见错误解决方案

### 错误1：USERKEY_PLAT_NOMATCH

**错误原因：**
API密钥的平台类型不匹配，常见原因：
1. 使用了错误的Key类型
   - 前端使用了Web服务API的Key → 应使用Web端(JS API)的Key
   - 后端使用了Web端(JS API)的Key → 应使用Web服务API的Key
2. 白名单配置问题
   - 当前访问的域名/IP不在API Key的白名单中
   - 开发环境需要使用 `localhost` 或 `127.0.0.1` 或 `*`
3. API密钥未正确配置
   - `.env` 文件中的 `VUE_APP_MAP_KEY` 未设置或设置错误
   - `application.yml` 中的 `map.api.key` 未设置或设置错误

**解决方案：**

**步骤1：检查环境变量文件**
- 前端：检查 `tourism-platform-frontend/.env.development` 文件是否存在
- 后端：检查 `application.yml` 中的 `map.api.key` 配置

**步骤2：验证API密钥类型**
1. 登录 [高德开放平台控制台](https://console.amap.com/)
2. 进入「应用管理」→「我的应用」
3. 找到你的应用，查看Key的「服务平台」类型
4. **前端Key必须选择「Web端(JS API)」**
5. **后端Key必须选择「Web服务API」**

**步骤3：配置白名单**
1. 在Key的配置页面，找到「安全密钥」或「白名单」设置
2. 开发环境建议设置为：
   - `localhost`
   - `127.0.0.1`
   - `*`（允许所有域名，仅用于开发）
3. 生产环境必须设置具体的域名，例如：
   - `yourdomain.com`
   - `www.yourdomain.com`

**步骤4：重启服务**
- 修改 `.env` 文件后，必须重启前端开发服务器
- 修改 `application.yml` 后，必须重启后端服务

**步骤5：清除浏览器缓存**
1. 按 `Ctrl+Shift+Delete` 打开清除数据对话框
2. 选择「缓存的图片和文件」
3. 点击「清除数据」
4. 刷新页面（F5）

### 错误2：INVALID_USER_SCODE

**错误原因：**
安全密钥验证失败，通常由以下原因导致：
1. Key类型不正确：前端应使用「Web端(JS API)」类型的Key
2. 安全域名未配置：高德开放平台中未添加当前访问域名到白名单
3. Key已失效或被禁用

**解决方案：**
1. 检查Key类型是否为「Web端(JS API)」
2. 在Key详情页面配置安全域名（开发环境添加 `localhost`、`127.0.0.1` 或 `*`）
3. 确认Key在控制台中已启用
4. 重启开发服务器并清除浏览器缓存

### 错误3：地图加载失败

**解决方案：**
- 检查 `.env` 文件中的 `VUE_APP_MAP_KEY` 是否正确
- 检查API密钥是否已开通Web端(JS API)服务
- 检查浏览器控制台错误信息
- 确认网络连接正常

### 错误4：路线规划失败

**解决方案：**
- 检查后端 `application.yml` 中的 `map.api.key` 是否正确
- 检查API密钥是否已开通Web服务API
- 检查起点和终点坐标是否有效
- 查看后端日志获取详细错误信息

### 错误5：定位功能不可用

**解决方案：**
- 定位功能需要HTTPS环境
- 开发环境可以使用localhost
- 检查浏览器是否允许定位权限
- 生产环境必须使用HTTPS

### 验证配置

#### 方法1：检查环境变量（浏览器控制台）
打开浏览器开发者工具（F12），在Console中输入：
```javascript
console.log(process.env.VUE_APP_MAP_KEY)
```
应该显示你的API密钥（不是 `your-map-key` 或 `undefined`）。

#### 方法2：检查网络请求
1. 打开开发者工具 → Network标签页
2. 刷新页面
3. 查找请求：`webapi.amap.com/maps?...`
4. 查看响应，不应该有 `USERKEY_PLAT_NOMATCH` 错误

#### 方法3：测试地图加载
访问地图页面，应该能看到：
- 地图正常显示
- 没有控制台错误
- 可以正常缩放和拖拽

### 快速检查清单

- [ ] `.env.development` 文件存在
- [ ] `VUE_APP_MAP_KEY` 已设置且不为空
- [ ] API Key的平台类型是「Web端(JS API)」（前端）
- [ ] API Key的平台类型是「Web服务API」（后端）
- [ ] 白名单包含 `localhost` 或 `*`
- [ ] 已重启开发服务器
- [ ] 已清除浏览器缓存
- [ ] 浏览器控制台无 `USERKEY_PLAT_NOMATCH` 错误

---

## 技术支持

- 高德开放平台文档：https://lbs.amap.com/api/javascript-api/summary
- 高德开放平台控制台：https://console.amap.com/
- DeepSeek开放平台：https://platform.deepseek.com/
